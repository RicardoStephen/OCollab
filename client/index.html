<html>
<head>
    <title>Collaborative Text Editor</title>
    <script type="text/javascript" src="ace-min/ace.js"></script>
    <script type="text/javascript" src="client.js"></script>
    <script type="text/javascript">

function req(type, path, params, success, error) {
    var xhr = new XMLHttpRequest();
    xhr.open(type, path, true);
    xhr.onload = function(e) {
        switch (this.status) {
            case 200:
                success.call(this, e);
                break;
            case 404:
            case 500:
                error.call(this, e);
                break;
            default:
                break;
        }
    };
    xhr.onerror = function(e) {
        error.call(this, e);
    };
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.send(params);
}

window.addEventListener("load", function() {
    if (location.search.length < 2) { // Home page
        createHome();
    }
    else {
        createEditor();
    }
});

function createHome() {
    var l = document.createElement("label");
    l.innerHTML = "Title:";
    var t = document.createElement("input");
    t.type = "text";
    var b = document.createElement("button");
    b.innerHTML = "Create a document";
    var out = document.createElement("div");
    b.addEventListener("click", function() {
        req("POST", "/create", "title=" + encodeURIComponent(t.value),
            function(e) {
                var id = this.responseText;
                var newloc = "?" + id;
                out.innerHTML += "<a href=\"" + newloc + "\">Document created</a>";
                setTimeout(function() {
                    location.href = newloc;
                }, 2000);
            },
            function(e) {
                out.innerHTML += "<div style=\"color:red\">Failed to create a document.</div>";
            }
        );
    });
    document.body.appendChild(l);
    document.body.appendChild(t);
    document.body.appendChild(document.createElement("br"));
    document.body.appendChild(b);
    document.body.appendChild(document.createElement("br"));
    document.body.appendChild(out);
}

function createEditor() {
    // Get document id
    var docid = location.search.substring(1);
    // Get session id
    req("POST", "/session", "docid=" + docid,
        function(e) {
            var sid = this.responseText;
            setupEditor(docid, sid);
        },
        function(e) {
            console.log("Could not get a session id");
        }
    );
}

var DEBUG = {};

function setupEditor(docid, sid) {
    var ta = document.createElement("div");
    document.body.appendChild(ta);
    ta.style.position = "absolute";
    ta.style.top = "5%";
    ta.style.left = "2%";
    ta.style.width = "45%";
    ta.style.height = "90%";
    
    // Create an editor around the box
    var editor = ace.edit(ta);
    editor.setTheme("ace/theme/clouds");
    
    req("POST", "/init", "sid=" + sid,
        function(e) {
            try {
                var data = JSON.parse(this.responseText);
                setupListeners(editor, docid, sid, data.title, data.text);
            }
            catch (e) {
                console.log("Could not parse response:");
                console.log(this.responseText);
            }
        },
        function(e) {
            console.log("Could not get initial document");
        }
    );
}

function setupListeners(editor, docid, sid, title, initialText) {
    // Display the title at the top
    var tdiv = document.createElement("div");
    tdiv.innerHTML = title;
    tdiv.style.position = "absolute";
    tdiv.style.top = "10px";
    tdiv.style.left = "10px";
    tdiv.style.fontSize = "2em";
    
    // Get the editor session
    var session = editor.getSession();
    editor.setValue(initialText);
    editor.$blockScrolling = Infinity;
    
    // Exchange data buffers
    var edits = [];
    
    // Event listeners
    session.selection.on("changeCursor", function(e) {
        //console.log(e);
        // TODO send position
    });
    
    // Turn a row / column to character position
    var coordToPos = function(c) {
        var offset = 0;
        for (var i = 0; i < c.row; i++) {
            offset += session.getScreenLastRowColumn(i) + 1;
        }
        offset += c.column;
        return offset;
    };
    
    var posToCoord = function(p) {
        var offset = p;
        var r = 0;
        var c = 0;
        while (offset >= 0 && r < session.getScreenLength()) {
            c = offset;
            offset -= session.getScreenLastRowColumn(r) + 1;
            if (offset >= 0) {
                r++;
            }
        }
        return {
            column: c,
            row: r
        };
    };
    
    session.on("change", function(e) {
        if (editor.curOp && editor.curOp.command.name) {
            var p = coordToPos(e.start);
            var t = e.lines.join("\n");
            var o = (e.action == "insert") ? "Insert" : (e.action == "remove") ? "Delete" : "";
            edits.push({ "op" : o, "pos" : p, "text" : t });
        }
    });
    
    // Exchange data
    setInterval(function() {
        // TODO Optimize edits
        
        // Prepare data to send
        var data = { patch : edits };
        req("POST", "/data",
            "sid=" + sid + "&data=" + encodeURIComponent(JSON.stringify(data)),
            function(e) {
                var data = JSON.parse(this.responseText);
                if (data.patch) {
                    // Add patches
                    data.patch.forEach(function (edit) {
                        if (edit.op == "Insert") {
                            session.insert(posToCoord(edit.pos), edit.text);
                        }
                        else if (edit.op == "Delete") {
                            var start = posToCoord(edit.pos);
                            var end = posToCoord(edit.pos + edit.text.length);
                            session.remove(new Range(start.row, start.column, end.row, end.column));
                        }
                    });
                }
            },
            function(e) {
            }
        );
        edits = [];
    }, 2000);
    
    DEBUG.editor = editor;
    DEBUG.session = session;
}

    </script>
</head>
<body>
</body>
</html>
